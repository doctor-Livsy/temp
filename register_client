from aiogram import types
from aiogram.dispatcher import FSMContext
from aiogram.dispatcher.filters import Command, Text
from aiogram.types import ReplyKeyboardRemove
from loader import dp, db, binance_pool, bybit_pool
from asyncpg.exceptions import UniqueViolationError
from keyboards.default import exchanges
from states.states import RegisterExchange


@dp.message_handler(Command("register_client"))
async def start_register_exchange(message: types.Message, state: FSMContext):
    try:
        await message.answer(f'{message.from_user.full_name}, клиент какой биржи зарегестрировать?',
                             reply_markup=exchanges)
        await state.update_data(user_id=message.from_user.id)
        await RegisterExchange.waiting_api_key.set()

    except Ecxeption:
        await message.answer('Ошибка. Повтори команду.')


@dp.message_handler(Text(equals=['BINANCE', 'BYBIT']), state=RegisterExchange.waiting_api_key)
async def register_exchange1(message: types.message, state: FSMContext):
    try:
        # Запись биржи
        await message.answer('Введите Binance Api Key клиента...',
                             reply_markup=ReplyKeyboardRemove())
        await state.update_data(exchange=message.text)
        await RegisterExchange.waiting_s_key.set()

    except Ecxeption:
        await message.answer('Ошибка. Повтори команду.')
        await state.reset_state()  # Сброс состояний


@dp.message_handler(state=RegisterExchange.waiting_s_key)
async def register_exchange2(message: types.message, state: FSMContext):
    try:
        # Проверка корректности ввода API Key
        if len(message.text) != 64:
            await message.answer('Неправильный API Key. Введи корректный API Key...')
            await RegisterExchange.waiting_s_key.set()
        else:
            # Запись API key
            await message.answer('Введите Binance Secret Key клиента...')
            await state.update_data(api_key=message.text)
            await RegisterExchange.enter_s_key.set()

    except Ecxeption:
        await message.answer('Ошибка. Повтори команду.')
        await state.reset_state()  # Сброс состояний

@dp.message_handler(state=RegisterExchange.enter_s_key)
async def register_exchange3(message: types.message, state: FSMContext):
    try:
        # Проверка корректности ввода Secret Key
        if len(message.text) != 64:
            await message.answer('Неправильный Secret Key. Введи корректный Secret Key...')
            await RegisterExchange.waiting_s_key.set()
        else:
            await state.update_data(s_key=message.text)  # Запись Secret key
            await create_client(message, state)  # Создание клиента
            await message.answer('Готово!')  # Завершение ввода данных

    except Ecxeption:
        await message.answer('Ошибка. Повтори команду.')
        await state.reset_state()  # Сброс состояний


@dp.message_handler(state=RegisterExchange.create_client)
async def create_client(message: types.message, state: FSMContext):
    try:
        await message.answer('Создаю клиент...')
        data = await state.get_data()
        try:
            await db.append_keys(user_id=data['user_id'],
                                 exchange=data['exchange'],
                                 api_key=data['api_key'],
                                 s_key=data['s_key'])

            # Регистрация клиента в Clients Pool
            pool = binance_pool if data['exchange'] == 'BINANCE' else bybit_pool
            pool.add_client(data['user_id'], data['api_key'], data['s_key'])

        except UniqueViolationError:
            await message.answer('Клиент с такими ключами уже зарегистрирован')

    except Ecxeption:
        await message.answer('Ошибка. Повтори команду.')
    finally:
        await state.reset_state()  # Сброс состояний


