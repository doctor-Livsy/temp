from aiogram import types
from aiogram.dispatcher import FSMContext
from aiogram.dispatcher.filters import Command
from loader import dp, db, binance_pool, bybit_pool
from keyboards.default import exchanges
from aiogram.types import ReplyKeyboardMarkup, KeyboardButton, \
    ReplyKeyboardRemove
from states.states import ManageTradeParameters
from .useful_functions import get_parameters, dict_to_string


async def check_user_init(message: types.Message):
    user = await db.give_user(user_id=message.from_user.id,
                              user_name=message.from_user.username)
    if user['user_id'] == message.from_user.id:
        return True
    else:
        return False


async def check_client_registration(message: types.Message):
    client = await db.select_api_info(user_id=message.from_user.id,
                                      exchange=message.text)
    if client is not None:
        return True
    else:
        return False


async def check_update(message, exchange, trade_pair):
    # Проверка факта записи параметров в БД
    check = await db.select_from_table('trade_pair', 'leverage',
                                       'margin_value',
                                       table='trade_parameters',
                                       user_id=message.from_user.id,
                                       exchange=exchange,
                                       trade_pair=trade_pair)
    # Отчет о записи параметров в БД
    await message.answer(f'Параметры {trade_pair} обновлены.\n'
                         f'Внесенные изменения: {dict_to_string(check)}')


async def update_client(pool, message, parameters):
    # Апдейт параметров в клиенте после изменений в БД
    pool.update_user_settings(user_id=message.from_user.id,
                              ticker=parameters['trade_pair'],
                              leverage=parameters['leverage'],
                              margin_value=parameters['margin_value'])
    # Загрузка параметров из клиентав для проверки
    check = pool.get_user_settings(user_id=user_id.from_user.id)

    success = 'Параметры клиента успешно обновлены'
    fail = 'Не удалось обновить параметры клиента'
    ticker = parameters['trade_pair']
    margin_value = parameters['margin_value']

    # Проверка обновления параметров клиента
    report = success if ticker in check.keys() and \
                        margin_value == check[ticker]['margin_value'] else fail
    # Отчет
    await message.answer(report)


def assemble_keyboard_trade_pairs(pairs: list, delete=False):
    if not delete:
        keyboard = ReplyKeyboardMarkup(
            keyboard=[[KeyboardButton(text='Добавить новую торговую пару')],
                      []],
            resize_keyboard=True)
    else:
        keyboard = ReplyKeyboardMarkup(resize_keyboard=True)

    if len(pairs) > 0:
        for pair in pairs:
            keyboard.add(KeyboardButton(pair))

    return keyboard


@dp.message_handler(Command("manage_trade_parameters"))
async def start_manage_parameters(message: types.Message):
    try:
        # Проверка прохождения инициализации командой Start
        if not await check_user_init(message):
            await message.answer('Не пройдена инициализация.\n '
                                 'Для начала выполни команду start')
        else:  # Выбор биржи с помощью клавиатуры
            await message.answer('Выбери биржу:', reply_markup=exchanges)
            await ManageTradeParameters.select_pair_for_editing.set()

    except Ecxeption:
        await message.answer('Ошибка. Повтори команду.')



@dp.message_handler(state=ManageTradeParameters.select_pair_for_editing)
async def select_pair_for_editing(message: types.message, state: FSMContext):
    try:
        # Проверка существования клиента с APIKEY в таблице с  ключами
        if not await check_client_registration(message):
            await message.answer(f'{message.text} клиент не зарегистрирован.\n'
                                 f'Для начала надо пройти регистрацию.',
                                 reply_markup=ReplyKeyboardRemove())
            # Сброс состояния
            await state.reset_state()

        else:  # Предложение выбора торговой пары для изменения или ввод новой пары
            # Подсчет записей в базе для выбранной биржи и список тикеров
            count_pair = await db.count_trade_pair(user_id=message.from_user.id,
                                                   exchange=message.text)
            list_pairs = await db.select_from_table('trade_pair',
                                                    table='trade_parameters',
                                                    user_id=message.from_user.id,
                                                    exchange=message.text)
            # Вывод имеющихся записей и предложения выбрать вариант с клавиатуры
            await message.answer(
                f'Число настроенных тикеров: {count_pair}\n{dict_to_string(list_pairs)}'
                f'Выбери нужный тикер для настройки или добавь новый с помощью клавиатуры ниже.',
                reply_markup=assemble_keyboard_trade_pairs(
                    list_pairs['trade_pair']))
            # Запись выбранной биржи и список тикеров для этой бирже в БД
            await state.update_data(exchange=message.text,
                                    pairs=list_pairs['trade_pair'])
            # Переход к вводу параметров
            await ManageTradeParameters.insert_parameters.set()

    except Ecxeption:
        await message.answer('Ошибка. Повтори команду.')
        await state.reset_state()


@dp.message_handler(state=ManageTradeParameters.insert_parameters)
async def insert_parameters(message: types.message, state: FSMContext):
    try:
        # Получение списка существующих тикеров в БД для выбранной биржи
        data = await state.get_data()

        # Отображение примера ввода параметров
        # В случае добавления новой торговой пары:
        if message.text == 'Добавить новую торговую пару':
            await message.answer(
                'Введи параметры (Тикер, Плечо, Маржа на вход (USD)).\n'
                'Пример ввода: BTCUSDT, 5, 100',
                reply_markup=ReplyKeyboardRemove())
            await ManageTradeParameters.writing_to_db.set()

        # Для изменения существующей записи:
        elif message.text in tuple(data['pairs']):
            await message.answer('Введи параметры (Плечо, Маржа на вход (USD)).\n'
                                 'Пример ввода: 5, 100',
                                 reply_markup=ReplyKeyboardRemove())
            await state.update_data(trade_pair=message.text)
            await ManageTradeParameters.writing_to_db.set()

        # Если выбран неверный тикер или значение не из предложенных кнопок
        else:
            await message.answer('В базе нет такой пары.'
                                 ' Добавь новую пару или выбери с помощью клавиатуры.')
            # Откат к выбору торговой пары или добавлению новой записи
            await ManageTradeParameters.insert_parameters.set()
    except Ecxeption:
        await message.answer('Ошибка. Повтори команду.')
        await state.reset_state()


@dp.message_handler(state=ManageTradeParameters.writing_to_db)
async def writing_to_db(message: types.message, state: FSMContext):
    try:
        data = await state.get_data()
        # Выделение параметров из введенного на прошлом шаге сообщения
        parameters = get_parameters(message.text)

        if len(parameters) == 3:
            await db.append_trade_pair(user_id=message.from_user.id,
                                       exchange=data['exchange'],
                                       trade_pair=parameters['trade_pair'],
                                       leverage=parameters['leverage'],
                                       margin_value=parameters['margin_value'])
        elif len(parameters) == 2:
            parameters['trade_pair'] = data['trade_pair']

            new_parameters = {'leverage': parameters['leverage'],
                              'margin_value': parameters['margin_value']}

            await db.update_data(new_parameters,
                                 table='trade_parameters',
                                 user_id=message.from_user.id,
                                 exchange=data['exchange'],
                                 trade_pair=parameters['trade_pair'])
        else:
            await message.answer('Неверное колличество введенных параметров')

        # Проверка записи в БД и отчет
        await check_update(message, data['exchange'], parameters['trade_pair'])
        # Апдейт параметров в клиенте после изменений в БД
        pool = binance_pool if data['exchange'] == 'BINANCE' else bybit_pool
        await update_client(pool, message.from_user.id, parameters)

    except Exception:
        await message.answer('Ошибка. Повтори команду.')
    finally:
        await state.reset_state()
