from loader import dp
from loader import binance_pool, bybit_pool
from api.BinanceClient import BinanceFuturesTrader as BinanceClient


# TODO: сделать функцию отправки стикеров
# TODO: возможность использования одного сигнала для нескольких торговых аккаунтов


def signals_for_bnc(sig):
    signals = {}

    if sig['side'] == 'buy':
        signals['side'] = 'BUY'
    elif sig['side'] == 'sell':
        signals['side'] = 'SELL'
    # signals['side'] = sig['side'].upper()


    old_symbol = str(sig['symbol'])
    try:
        signals['symbol'] = old_symbol.replace("PERP", "")
    except:
        pass

    signals['price'] = sig['price']
    signals['type'] = sig['type']

    return signals


async def bnc_futures_trade(alert, name, user_id):
    # формирование массива сигналов для Binance
    signal = signals_for_bnc(alert)
    # Исполнение торгового сигнала
    
    client = BinanceClient(binance_pool.get_client(user_id=user_id),
                           binance_pool.get_user_settings(user_id=user_id))
    ord, rprt = client.execute_futures_trade(signal)
    
    order, report = BinanceClient(clients[name]['binance_client'],
                    users[name]['settings']['futures']).execute_futures_trade(signal)
    # Запрос информации по позиции
    position = clients[name]['binance_client'].futures_position_information(symbol=signal['symbol'])[0]
    # Формирование отчета по совершенной операции
    try:
        trade_message = (f"Сигнал на Binance - {signal['type']}:\n"
                         f"Инструмент: {order['symbol']} - {order['side']},\n"
                         f"Количество: order['origQty'] .\n"
                         f"\n"
                         f"Текущая позиция по {position['symbol']}:\n"
                         f"Количество: {position['positionAmt']},\n"
                         f"Вход по {position['entryPrice']},\n"
                         f"Ликвидация {position['liquidationPrice']},\n"
                         f"Маржа на позицию {position['isolatedMargin']} - {position['leverage']} x")

        await dp.bot.send_message(users[name]['chat_id'], trade_message)
    except:
        await dp.bot.send_message(users[name]['chat_id'], report)


@dp.channel_post_handler(lambda alert: alert.text == "tr_view_trade")
async def trade_tview_signal(alert):
    name = alert.values['name']
    user_id = alert.values['id']
    
    if alert.values['exchange'] == "BINANCE":
        if alert.values['trade']['format'] == "F":
            for name in alert.values['name'].values():
                await bnc_futures_trade(alert.values['trade'], name, user_id)

        elif alert.values['trade']['format'] == "M":
            pass

        else:
            await dp.bot.send_message(users[name]['chat_id'], 'Неопознанный тип торговли. Проверь trade: format')
    else:
        await dp.bot.send_message(users[name]['chat_id'], 'Сигнал не для Binance. Проверь сигнал с TView')
